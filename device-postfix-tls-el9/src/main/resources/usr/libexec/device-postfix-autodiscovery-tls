#!/bin/bash

#
# Postfix Autodiscovery - TLS
# ===========================
# 
# This script autogenerates the inbound TLS configuration for a postfix server.

set -e
umask 0022


#
# Generate Config
# ---------------
#

install -m 0750 -d /run/postfix/ca-certs /run/postfix/certs /run/postfix/private

if [ -f "/etc/device/services/mail/tls/tls-dns.txt" ]; then

  tls_dns=$(head -n 1 /etc/device/services/mail/tls/tls-dns.txt)

  logger -t postfix-autodiscovery "importing postfix server certificate/key..."

  redwax-tool --pem-in="/etc/pki/tls/private/*" \
              --pem-in="/etc/pki/tls/certs/ca-bundle.trust.crt" \
              --pem-in="/etc/pki/tls/certs/*.pem" \
              --filter=verify \
              --filter-hostname="${tls_dns}" \
              --filter-current \
              --cert-out --chain-out --no-key-out \
              --pem-out="/run/postfix/certs/smtpd.crt" \
              --no-cert-out --no-chain-out --trust-out \
              --pem-out="/run/postfix/ca-certs/ssl-cacert.pem" \
              --no-chain-out --no-trust-out --key-out \
              --pem-out="/run/postfix/private/smtpd.key" || echo "Could not import cert/key for tls" > "error"

  if test ! -f "error"; then
    logger -t postfix-autodiscovery "imported postfix server certificate/key."
  else
    logger -t postfix-autodiscovery "failed to import postfix server certificate/key."
  fi

if test -L "/etc/device/services/mail/tls/tls-client-ca.crt"; then
  smtpd_tls_CAfile=$(readlink -f "/etc/device/services/mail/tls/tls-client-ca.crt")
else
  smtpd_tls_CAfile=
fi

  smtpd_tls_cert_file="/run/postfix/certs/smtpd.crt"
  smtpd_tls_key_file="/run/postfix/private/smtpd.key"
  smtpd_tls_security_level="may"

  cat >> "main.cf" <<- EOF
# Note: certificate from /etc/device/services/mail/tls/tls-dns.txt

# INBOUND TLS CONFIGURATION
#
# The following certificates are used for inbound connections.

# The full pathname of a file with the Postfix SMTP server RSA certificate
# in PEM format. Intermediate certificates should be included in general,
# the server certificate first, then the issuing CA(s) (bottom-up order).
#
smtpd_tls_cert_file = ${smtpd_tls_cert_file}

# The full pathname of a file with the Postfix SMTP server RSA private key
# in PEM format. The private key must be accessible without a pass-phrase,
# i.e. it must not be encrypted.
#
smtpd_tls_key_file = ${smtpd_tls_key_file}

# A file containing (PEM format) CA certificates of root CAs trusted to
# sign either remote SMTP client certificates or intermediate CA
# certificates.
#
smtpd_tls_CAfile = ${smtpd_tls_CAfile}

# Announce STARTTLS support to remote SMTP clients, but do not require that
# clients use TLS encryption (opportunistic TLS inbound).
#
smtpd_tls_security_level = ${smtpd_tls_security_level}

# When TLS encryption is optional in the Postfix SMTP server, do not
# announce or accept SASL authentication over unencrypted connections.
#
smtpd_tls_auth_only = yes

# Ask a remote SMTP client for a client certificate. This information is
# needed for certificate based mail relaying with, for example, the
# permit_tls_clientcerts feature.
#
smtpd_tls_ask_ccert = yes

# Request that the Postfix SMTP server produces Received: message headers that
# include information about the protocol and cipher used, as well as the
# remote SMTP client CommonName and client certificate issuer CommonName. This
# is disabled by default, as the information may be modified in transit
# through other mail servers. Only information that was recorded by the final
# destination can be trusted.
#
smtpd_tls_received_header = yes

EOF


  #
  # Open up inet_interfaces
  postconf -c . inet_interfaces=all

fi


if test -L "/etc/device/services/mail/tls/tls-ca.crt"; then
  smtp_tls_CAfile=$(readlink -f "/etc/device/services/mail/tls/tls-ca.crt")
else
  smtp_tls_CAfile=/etc/pki/tls/certs/ca-bundle.crt
fi

smtp_tls_security_level="may"

cat >> "main.cf" <<- EOF

# Note: CA certificate from /etc/device/services/mail/tls/tls-client-dns.txt.

# OUTBOUND TLS CONFIGURATION
#
# The following certificates are used for outbound connections.

# Directory with PEM format Certification Authority certificates that the
# Postfix SMTP client uses to verify a remote SMTP server certificate.
#
smtp_tls_CApath =

# The full pathname of a file containing CA certificates of root CAs
# trusted to sign either remote SMTP server certificates or intermediate CA
# certificates.
#
smtp_tls_CAfile = ${smtp_tls_CAfile}

# Use TLS if this is supported by the remote SMTP server, otherwise use
# plaintext (opportunistic TLS outbound).
#
smtp_tls_security_level = ${smtp_tls_security_level}

EOF

if [ -f "/etc/device/services/mail/tls/tls-client-dns.txt" ]; then

  tls_client_dns=$(head -n 1 /etc/device/services/mail/tls/tls-client-dns.txt)

  logger -t postfix-autodiscovery "importing postfix client certificate/key..."

  install -m 0750 -d /run/postfix/ca-certs /run/postfix/certs /run/postfix/private

  redwax-tool --pem-in="/etc/pki/tls/private/*" \
              --pem-in="/etc/pki/tls/certs/ca-bundle.trust.crt" \
              --pem-in="/etc/pki/tls/certs/*.pem" \
              --filter=verify \
              --filter-hostname="${tls_client_dns}" \
              --filter-current \
              --cert-out --chain-out --no-key-out \
              --pem-out="/run/postfix/certs/smtp.crt" \
              --no-cert-out --no-chain-out --trust-out \
              --pem-out="/run/postfix/ca-certs/ssl-cacert.pem" \
              --no-chain-out --no-trust-out --key-out \
              --pem-out="/run/postfix/private/smtp.key" || echo "Could not import cert/key for tls-client" > "error"

  if test ! -f "error"; then
    logger -t postfix-autodiscovery "imported postfix client certificate/key."
  else
    logger -t postfix-autodiscovery "failed to import postfix client certificate/key."
  fi

  smtp_tls_cert_file="/run/postfix/certs/smtp.crt"
  smtp_tls_key_file="/run/postfix/private/smtp.key"

  cat >> "main.cf" <<- EOF

# Note: client certificates from /etc/device/services/mail/tls/tls-client-dns.txt.

# File with the Postfix SMTP client RSA certificate in PEM format.
smtp_tls_cert_file = ${smtp_tls_cert_file}
smtp_tls_key_file = ${smtp_tls_key_file}

EOF

fi

restorecon -R /run/postfix

